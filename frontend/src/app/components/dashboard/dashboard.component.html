<div class="dashboard-container" [class.sidebar-collapsed]="isSidebarCollapsed">
  <!-- Sidebar -->
  <aside class="sidebar">
    <div class="sidebar-header">
      <h2>Eventy</h2>
      <button class="collapse-btn" (click)="toggleSidebar()">
        <span class="material-icons">
          {{ isSidebarCollapsed ? 'menu' : 'close' }}
        </span>
      </button>
    </div>
    
    <nav class="sidebar-nav">
      <ul>
        <li>
          <a routerLink="/dashboard" routerLinkActive="active" [routerLinkActiveOptions]="{ exact: true }" class="nav-item">
            <span class="material-icons">dashboard</span>
            <span class="nav-text">Dashboard</span>
          </a>
        </li>
        <li>
          <a routerLink="/events" routerLinkActive="active" class="nav-item">
            <span class="material-icons">event</span>
            <span class="nav-text">Events</span>
          </a>
        </li>

      </ul>
    </nav>
    <div class="copyright" style="position: absolute; bottom: 20px; left: 20px; color: #666; font-size: 12px;">
      © 2025 Kavya Infoweb Pvt Ltd.
    </div>
  </aside>

  <!-- Main Content -->
  <main class="main-content">
    <!-- Navbar -->
    <nav class="navbar">
      <div class="navbar-left">
        <!-- <h1>Dashboard</h1> -->
      </div>
      
      <div class="navbar-right">
        <div class="search-bar">
          <input type="text" placeholder="Search..." [(ngModel)]="searchQuery" class="search-input">
          <select [(ngModel)]="selectedCategory" class="category-filter">
            <option value="all">All Categories</option>
            <option *ngFor="let cat of categories" [value]="cat">{{cat}}</option>
          </select>
          <button class="search-btn" (click)="applySearch()">
            <span class="material-icons">search</span>
          </button>
        </div>
        
        <div class="nav-actions">
          <div class="notification-dropdown" (clickOutside)="closeNotificationDropdown()">
            <button class="icon-btn" (click)="toggleNotificationDropdown($event)">
              <span class="material-icons">notifications</span>
              <span *ngIf="notificationCount > 0" class="notification-badge">{{notificationCount}}</span>
            </button>
            <div class="dropdown-menu notification-menu" [class.show]="isNotificationDropdownOpen">
              <div class="dropdown-header">
                <h4>Notifications</h4>
                <span *ngIf="notificationCount > 0" class="count-badge">{{notificationCount}}</span>
              </div>
              <div class="dropdown-content">
                <div *ngIf="notifications.length === 0" class="empty-state">
                  <span class="material-icons">notifications_none</span>
                  <p>No notifications</p>
                </div>
                <div *ngFor="let notification of notifications" class="notification-item" [class.unread]="!notification.read">
                  <div class="notification-content">
                    <h5>{{notification.title}}</h5>
                    <p>{{notification.message}}</p>
                    <small>{{notification.time | date:'short'}}</small>
                  </div>
                </div>
              </div>
            </div>
          </div>
          
          <div class="message-dropdown" (clickOutside)="closeMessageDropdown()">
            <button class="icon-btn" (click)="toggleMessageDropdown($event)">
              <span class="material-icons">mail</span>
              <span *ngIf="messageCount > 0" class="notification-badge">{{messageCount}}</span>
            </button>
            <div class="dropdown-menu message-menu" [class.show]="isMessageDropdownOpen">
              <div class="dropdown-header">
                <h4>Messages</h4>
                <span *ngIf="messageCount > 0" class="count-badge">{{messageCount}}</span>
              </div>
              <div class="dropdown-content">
                <div *ngIf="messages.length === 0" class="empty-state">
                  <span class="material-icons">mail_outline</span>
                  <p>No messages</p>
                </div>
                <div *ngFor="let message of messages" class="message-item" [class.unread]="!message.read">
                  <div class="message-content">
                    <h5>From: {{message.from}}</h5>
                    <h6>{{message.subject}}</h6>
                    <p>{{message.message}}</p>
                    <small>{{message.time | date:'short'}}</small>
                  </div>
                </div>
              </div>
            </div>
          </div>
          <div class="profile-dropdown" (clickOutside)="closeProfileMenu()">
            <button class="profile-btn" (click)="toggleProfileMenu()">
              <img [src]="profileImageUrl" alt="Profile">
              <span>{{displayName}}</span>
              <span class="material-icons dropdown-icon">{{ isProfileMenuOpen ? 'arrow_drop_up' : 'arrow_drop_down' }}</span>
            </button>
            <div class="dropdown-menu" [class.show]="isProfileMenuOpen">
              <button type="button" class="dropdown-item" (click)="openProfileSettings($event)">
                <span class="material-icons">person</span>
                <span>Profile Settings</span>
              </button>
              <div class="dropdown-divider"></div>
              <button type="button" class="dropdown-item" (click)="logout($event)">
                <span class="material-icons">logout</span>
                <span>Logout</span>
              </button>
            </div>
          </div>
        </div>
      </div>
    </nav>

    <!-- Dashboard Content -->
    <div class="dashboard-content">
      <div class="welcome-section">
        <h2>Welcome,</h2>
        <p>Discover and book the most exciting events happening from cultural festivals to tech summits and more!</p>
      </div>

      <div class="section-header">
        <h3>Featured Events</h3>
        <button class="view-more-button" (click)="goToEvents()">
          View More Events
          <span class="material-icons">arrow_forward</span>
        </button>
      </div>

      <!-- Events List -->
      <div class="events-row">
        <div class="event-card" *ngFor="let event of filteredEvents">
          <div class="event-image">
            <img [src]="event.imageUrl" [alt]="event.title">
            <div class="event-date">
              <span class="material-icons">calendar_today</span>
              {{event.date | date:'mediumDate'}}
            </div>
          </div>
          
          <div class="event-details">
            <h3>{{event.title}}</h3>
            <p class="event-description">{{event.description}}</p>
            
            <div class="event-info">
              <div class="info-item">
                <span class="material-icons">location_on</span>
                {{event.location}}
              </div>
              <div class="info-item">
                <span class="material-icons">schedule</span>
                {{event.time}}
              </div>
              <div class="info-item">
                <span class="material-icons">event_seat</span>
                {{event.availableSeats}} seats left
              </div>
            </div>
            
            <div class="event-footer">
              <div class="event-price">
                ₹{{event.price}}
              </div>
              <button class="book-button" (click)="openBookingModal(event)" [disabled]="event.availableSeats === 0">
                {{ event.availableSeats > 0 ? 'Book Now' : 'Sold Out' }}
              </button>
            </div>
          </div>
        </div>
      </div>

      <div class="view-all-events">
        <button class="view-more-button" (click)="goToEvents()">
          View All Events
          <span class="material-icons">arrow_forward</span>
        </button>
      </div>
    </div>
  </main>

  <!-- Booking Modal -->
  <div class="modal-overlay" *ngIf="showBookingModal" (click)="closeBookingModal()">
    <div class="modal-content" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h2>Book Event Tickets</h2>
        <button class="close-button" (click)="closeBookingModal()">
          <span class="material-icons">close</span>
        </button>
      </div>

      <div class="modal-body" *ngIf="selectedEvent">
        <div class="event-summary">
          <h3>{{selectedEvent.title}}</h3>
          <p class="event-datetime">
            {{selectedEvent.date | date:'mediumDate'}} at {{selectedEvent.time}}
          </p>
          <p class="event-location">
            <span class="material-icons">location_on</span>
            {{selectedEvent.location}}
          </p>
        </div>

        <div class="ticket-selection">
          <label>Number of Tickets:</label>
          <div class="ticket-counter">
            <button 
              (click)="ticketCount = ticketCount - 1" 
              [disabled]="ticketCount <= 1"
            >-</button>
            <span>{{ticketCount}}</span>
            <button 
              (click)="ticketCount = ticketCount + 1" 
              [disabled]="ticketCount >= selectedEvent.availableSeats"
            >+</button>
          </div>
        </div>

        <div class="price-summary">
          <div class="price-row">
            <span>Ticket Price:</span>
            <span>₹{{selectedEvent.price}} × {{ticketCount}}</span>
          </div>
          <div class="price-row total">
            <span>Total:</span>
            <span>₹{{getTotalPrice() | number:'1.0-0'}}</span>
          </div>
        </div>
      </div>

      <div class="modal-footer">
        <button class="cancel-button" (click)="closeBookingModal()">Cancel</button>
        <button class="confirm-button" (click)="bookTickets()">
          Confirm Booking
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Payment Modal -->
<div>
  <!-- Payment Modal -->
  <div class="modal-overlay" *ngIf="showPaymentModal" (click)="closePaymentModal()">
    <div class="modal-content" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h2>Payment</h2>
        <button class="close-button" (click)="closePaymentModal()">
          <span class="material-icons">close</span>
        </button>
      </div>

      <div class="modal-body">
        <div *ngIf="paymentStep === 'enter'">
          <p>Enter your email to receive the ticket after payment:</p>
          <input type="email" [(ngModel)]="paymentEmail" placeholder="you@example.com">
          <div style="margin-top:12px">
            <button class="btn-cancel" (click)="closePaymentModal()">Cancel</button>
            <button class="btn-submit" (click)="onPayNow()" [disabled]="paymentProcessing">
              Continue to Payment
            </button>
          </div>
          <div *ngIf="paymentError" style="color:#b00020;margin-top:8px">{{paymentError}}</div>
        </div>

        <div *ngIf="paymentStep === 'method'">
          <p>Select a payment method:</p>
          <div class="payment-methods">
            <button class="btn-method" (click)="selectedPaymentMethod='upi'" [class.active]="selectedPaymentMethod==='upi'">
              <span class="pm-icon">🔗</span>
              <span>UPI</span>
            </button>

            <button class="btn-method" (click)="selectedPaymentMethod='card_credit'" [class.active]="selectedPaymentMethod==='card_credit'">
              <span class="pm-icon">💳</span>
              <span>Credit Card</span>
            </button>

            <button class="btn-method" (click)="selectedPaymentMethod='card_debit'" [class.active]="selectedPaymentMethod==='card_debit'">
              <span class="pm-icon">🏧</span>
              <span>Debit Card</span>
            </button>

            <button class="btn-method" (click)="selectedPaymentMethod='wallet'" [class.active]="selectedPaymentMethod==='wallet'">
              <span class="pm-icon">👛</span>
              <span>Wallet</span>
            </button>

            <button class="btn-method" (click)="selectedPaymentMethod='netbank'" [class.active]="selectedPaymentMethod==='netbank'">
              <span class="pm-icon">🏦</span>
              <span>Net Banking</span>
            </button>
          </div>

          <div class="method-actions">
            <button class="btn-cancel" (click)="paymentStep='enter'">Back</button>
            <button class="btn-submit" [disabled]="!selectedPaymentMethod" (click)="selectPaymentMethod(selectedPaymentMethod)">Pay with Selected Method</button>
          </div>
        </div>

        <!-- Card details form -->
        <div *ngIf="paymentStep === 'card_form'">
          <h4>Enter card details</h4>
          <div class="form-row">
            <label>Card Number</label>
            <input type="text" [(ngModel)]="cardNumber" placeholder="1234 5678 9012 3456">
          </div>
          <div class="form-row">
            <label>Card Holder</label>
            <input type="text" [(ngModel)]="cardHolder" placeholder="CARDHOLDER NAME">
          </div>
          <div class="form-row inline">
            <div>
              <label>Expiry Month</label>
              <input type="text" [(ngModel)]="cardExpiryMonth" placeholder="MM">
            </div>
            <div>
              <label>Expiry Year</label>
              <input type="text" [(ngModel)]="cardExpiryYear" placeholder="YYYY">
            </div>
            <div>
              <label>CVV</label>
              <input type="password" [(ngModel)]="cardCvv" placeholder="CVV">
            </div>
          </div>
          <div style="margin-top:12px">
            <button class="btn-cancel" (click)="paymentStep='method'">Back</button>
            <button class="btn-submit" (click)="verifyCardDetailsAndProceed()">Verify & Continue</button>
          </div>
          <div *ngIf="paymentError" style="color:#b00020;margin-top:8px">{{paymentError}}</div>
        </div>

        <!-- Wallet app selector -->
        <div *ngIf="paymentStep === 'wallet_select'">
          <h4>Select Wallet App</h4>
          <div class="wallet-grid">
            <button class="wallet-btn" (click)="selectWalletApp('gpay')">Google Pay</button>
            <button class="wallet-btn" (click)="selectWalletApp('phonepe')">PhonePe</button>
            <button class="wallet-btn" (click)="selectWalletApp('paytm')">Paytm</button>
            <button class="wallet-btn" (click)="selectWalletApp('bhim')">BHIM</button>
          </div>
          <div style="margin-top:12px">
            <button class="btn-cancel" (click)="paymentStep='method'">Back</button>
          </div>
        </div>

        <!-- UPI form -->
        <div *ngIf="paymentStep === 'upi_form'">
          <h4>Enter UPI ID</h4>
          <p>Enter your UPI ID (e.g. name@bank) to verify.</p>
          <input type="text" [(ngModel)]="upiId" placeholder="name@bank">
          <div style="margin-top:12px">
            <button class="btn-cancel" (click)="paymentStep='method'">Back</button>
            <button class="btn-submit" (click)="verifyUpiAndProceed()">Verify UPI & Continue</button>
          </div>
          <div *ngIf="paymentError" style="color:#b00020;margin-top:8px">{{paymentError}}</div>
        </div>

        <!-- Netbanking form -->
        <div *ngIf="paymentStep === 'netbank_form'">
          <h4>Net Banking Login</h4>
          <p>Enter your netbanking username & password (demo).</p>
          <div class="form-row">
            <label>Username</label>
            <input type="text" [(ngModel)]="netbankUser" placeholder="username">
          </div>
          <div class="form-row">
            <label>Password</label>
            <input type="password" [(ngModel)]="netbankPassword" placeholder="password">
          </div>
          <div style="margin-top:12px">
            <button class="btn-cancel" (click)="paymentStep='method'">Back</button>
            <button class="btn-submit" (click)="verifyNetbankAndProceed()">Verify & Continue</button>
          </div>
          <div *ngIf="paymentError" style="color:#b00020;margin-top:8px">{{paymentError}}</div>
        </div>

        <div *ngIf="paymentStep === 'processing'" style="text-align:center; padding:20px">
          <div class="spinner" style="margin:auto;margin-bottom:12px">⏳</div>
          <div>Processing your payment via <strong>{{selectedPaymentMethod}}</strong>…</div>
        </div>

        <!-- Confirmation modal (shown briefly before processing) -->
        <div *ngIf="paymentStep === 'confirm'" class="confirm-panel">
          <h4>Confirm Payment</h4>
          <p>Method: <strong>{{selectedPaymentMethod}}</strong></p>
          <p>Amount: <strong>₹{{getTotalPrice() | number:'1.0-0'}}</strong></p>
          <div style="margin-top:12px; text-align:center">
            <button class="btn-cancel" (click)="paymentStep='method'">Change</button>
            <button class="btn-submit" (click)="performPayment(selectedPaymentMethod)">Confirm & Pay</button>
          </div>
        </div>

        <div *ngIf="paymentSuccess" class="payment-success">
          <div class="success-badge">✓</div>
          <h3>Payment Successful</h3>
          <p>Your booking is confirmed. A QR code and ticket have been generated.</p>

          <div class="qr-preview">
            <img *ngIf="qrUrl" [src]="qrUrl" alt="QR Code" width="220" height="220" crossorigin="anonymous">
            <div *ngIf="!qrUrl" style="color:#666;font-size:14px">QR not available</div>
          </div>

          <div style="margin-top:12px; display:flex; gap:8px; justify-content:center;">
            <button class="btn-submit" (click)="downloadTicket()">Download Ticket</button>
            <button class="btn-cancel" (click)="sendTicketByEmail()">Send via Email</button>
            <button class="btn-cancel" (click)="closePaymentModal()">Close</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Preview Modal (Ethereal) -->
  <div class="modal-overlay" *ngIf="showPreviewModal" (click)="closePreviewModal()">
    <div class="modal-content" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h2>Email Sent</h2>
        <button class="close-button" (click)="closePreviewModal()">
          <span class="material-icons">close</span>
        </button>
      </div>
      <div class="modal-body">
        <p>Your ticket email was sent. If using Ethereal, preview it here:</p>
        <div *ngIf="lastPreviewUrl">
          <a [href]="lastPreviewUrl" target="_blank">Open preview</a>
        </div>
        <div *ngIf="!lastPreviewUrl">No preview URL available.</div>
      </div>
      <div class="modal-footer">
        <button class="btn-cancel" (click)="closePreviewModal()">Close</button>
      </div>
    </div>
  </div>


</div>
